<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agentic RAG - UI</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial; max-width: 900px; margin: 40px auto; padding: 0 16px; }
    h1 { margin: 0 0 14px; }
    .row { display: flex; gap: 10px; }
    textarea { width: 100%; height: 90px; padding: 10px; font-size: 14px; }
    input[type="number"] { width: 90px; padding: 8px; }
    button { padding: 10px 16px; cursor: pointer; }
    .card { margin-top: 16px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .muted { color: #666; font-size: 13px; }
    ul { margin: 8px 0 0 18px; }
  </style>
</head>
<body>
  <h1>Agentic RAG</h1>
  <div class="muted">Ask questions over your indexed PDF. Endpoint: <code>/query</code></div>

  <div class="card">
    <div class="row">
      <textarea id="q" placeholder="Ask a question..."></textarea>
    </div>
    <div class="row" style="margin-top:10px; align-items:center;">
      <label class="muted">top_k</label>
      <input id="topk" type="number" min="1" max="20" value="8" />
      <button id="askBtn">Ask</button>
      <button id="ingestBtn">Re-ingest</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;">Answer</h3>
    <pre id="answer" class="muted">No answer yet.</pre>
    <h3 style="margin:14px 0 8px;">Citations</h3>
    <ul id="cites" class="muted"></ul>
  </div>

  <script>
    const qEl = document.getElementById("q");
    const topkEl = document.getElementById("topk");
    const answerEl = document.getElementById("answer");
    const citesEl = document.getElementById("cites");
    const statusEl = document.getElementById("status");

    function setStatus(msg) { statusEl.textContent = msg; }

    async function ask() {
      const question = qEl.value.trim();
      const top_k = parseInt(topkEl.value || "8", 10);

      if (!question) return;

      setStatus("Thinking...");
      answerEl.textContent = "";
      citesEl.innerHTML = "";

      try {
        const res = await fetch("/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, top_k })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`HTTP ${res.status}: ${txt}`);
        }

        const data = await res.json();
        answerEl.textContent = data.answer || "(no answer)";

        const cites = data.citations || [];
        if (cites.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No citations returned.";
          citesEl.appendChild(li);
        } else {
          for (const c of cites) {
            const li = document.createElement("li");
            li.textContent = `${c.source} | ${c.chunk_id} | score=${(c.score ?? 0).toFixed?.(3) ?? c.score}`;
            citesEl.appendChild(li);
          }
        }

        setStatus("Done.");
      } catch (e) {
        setStatus("Error.");
        answerEl.textContent = String(e);
      }
    }

    async function ingest() {
      setStatus("Re-ingesting...");
      try {
        const res = await fetch("/ingest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: "{}"
        });
        const data = await res.json();
        setStatus(data.message || "Ingest complete.");
      } catch (e) {
        setStatus("Ingest error.");
        answerEl.textContent = String(e);
      }
    }

    document.getElementById("askBtn").addEventListener("click", ask);
    document.getElementById("ingestBtn").addEventListener("click", ingest);
    qEl.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") ask();
    });
  </script>
</body>
</html>

